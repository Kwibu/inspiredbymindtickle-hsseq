<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driver Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --title-bg:#ffffff;
      --title-shadow:0 2px 8px rgba(0,0,0,0.12);
      --brand:#111827;
      --accent:#4CAF50;
      --danger:#f44336;
      --muted:#94a3b8;
      --fs-base: clamp(14px, 2.8vw, 16px);
      --fs-h2: clamp(20px, 6vw, 28px);
      --space: clamp(10px, 2.5vw, 16px);
    }
    html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background:url('trucks.jpg') no-repeat center center fixed; background-size:cover; font-size:var(--fs-base); }
    body::before { content:""; position:fixed; inset:0; background:rgba(255,255,255,0.85); z-index:-1; }
    .section{ display:none; padding:20px; } .active{ display:block; }
    h2{ font-size:var(--fs-h2); font-weight:700; color:#222; background:var(--title-bg); display:inline-block; padding:14px 20px; border-radius:12px; box-shadow:var(--title-shadow); margin:0; }
    .heading-wrap{ display:flex; align-items:center; justify-content:center; margin-bottom:20px; }
    input, select, button{ margin:10px 0; padding:calc(var(--space)*0.75) var(--space); width:100%; max-width:520px; font-size:var(--fs-base); border-radius:10px; border:1px solid #e5e7eb; }
    button{ background-color:var(--accent); color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
    .muted{ background-color:var(--muted); } .danger{ background-color:var(--danger); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .row{ display:flex; gap:var(--space); flex-wrap:wrap; }
    .card{ background:#fff; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08); padding:16px; flex:1 1 320px; min-width:300px; }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:8px; }
    .tabs{ display:flex; gap:8px; margin:12px 0 16px; align-items:center; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{ padding:10px 14px; border-radius:999px; background:#e5e7eb; cursor:pointer; user-select:none; white-space:nowrap; }
    .tab.active{ background:var(--brand); color:#fff; }
    #lobbyEmpty,#historyEmpty{ background:rgba(255,255,255,0.95); color:#222; padding:12px 16px; border-radius:10px; font-weight:500; box-shadow:0 2px 6px rgba(0,0,0,0.12); display:inline-block; margin-top:20px; }
    .tabs .tab{ background:rgba(255,255,255,0.9); color:#111; font-weight:600; } .tabs .tab.active{ background:var(--brand); color:#fff; }
    .dashbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .driver-badge{ font-weight:600; font-size:14px; background:#111827; color:#fff; padding:8px 12px; border-radius:999px; box-shadow:var(--title-shadow); white-space:nowrap; }
    #videoNote{ background:#fff; padding:16px; margin:12px 0; border-radius:12px; max-width:820px; box-shadow:var(--title-shadow); font-size:16px; font-weight:600; color:#222; white-space:pre-line; }
    #videoContainer{ width:100%; max-height:80vh; }
    #videoContainer iframe, #videoContainer video{ width:100%; height:min(56.25vw,70vh); border-radius:12px; }
    #completionSection{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#ffffffee; padding:12px 16px; border-radius:12px; box-shadow:0 0 10px #ccc; display:none; }
    .toast{ position:fixed; top:12px; left:50%; transform:translateX(-50%); background:#1f2937; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.2); opacity:.95; font-size:14px; }
    /* Admin styles */
    #adminLoginBtn { background: var(--brand); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 16px auto; display: block; max-width: 520px; }
    #adminPanelBtn { background: #6b7280; margin-left: auto; }
    .admin-section { background: white; border-radius: 12px; padding: 20px; max-width: 800px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .admin-form { display: flex; flex-direction: column; gap: 12px; }
    .admin-form-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .admin-form-row > * { flex: 1; min-width: 200px; }
    .video-list { margin-top: 20px; }
    .video-item { background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .video-item-actions { display: flex; gap: 8px; }
    .video-item-actions button { padding: 6px 12px; font-size: 12px; max-width: none; }
    #newLangName { flex: 1; min-width: 200px; }
    #addLangBtn { max-width: 150px; }
    #adminEmail { width: 100%; max-width: 100%; box-sizing: border-box; }
    @media (max-width:640px){
      html,body{ background-attachment:scroll; } body::before{ background:rgba(255,255,255,0.92); }
      .dashbar{ flex-wrap:wrap; gap:8px; }
      #syncBtn,#changeDriverBtn{ display:none!important; }
      .card{ min-width:auto; flex:1 1 100%; } .driver-badge{ font-size:12px; }
      #completionSection{ right:12px; left:auto; bottom:12px; transform:none; } button{ padding:14px; }
      .admin-form-row > * { flex: 1 1 100%; }
      #addLangBtn { max-width: 100%; }
    }
  </style>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
  <!-- Language selection -->
  <div id="languageSection" class="section active" style="text-align:center">
    <div class="heading-wrap"><h2 id="langTitle">Select Language / Chagua Lugha / Saleni Ululimi / Selecione o Idioma</h2></div>
    <div style="max-width:520px;margin:0 auto">
      <select id="languageSelect" required></select>
      <button type="button" id="continueBtn">Continue</button>
      <button id="adminLoginBtn">Admin Login</button>
    </div>
  </div>

  <!-- Check-in form -->
  <form id="checkinForm" class="section" autocomplete="off" style="text-align:center">
    <div class="heading-wrap"><h2 id="formTitle">Driver Check-In</h2></div>
    <div style="max-width:520px;margin:0 auto">
      <input type="text" id="name" list="driverNames" placeholder="Full Name" required />
      <datalist id="driverNames"></datalist>
      <input type="text" id="truck" placeholder="Truck Number" required />
      <div class="row">
        <button type="button" id="backBtn" class="danger" style="flex:1">Back</button>
        <button type="submit" id="submitBtn" style="flex:2">Continue to Dashboard</button>
      </div>
    </div>
  </form>

  <!-- DASHBOARD -->
  <div id="dashboardSection" class="section">
    <div class="dashbar">
      <h2 id="dashTitle">Training Dashboard</h2>
      <div id="driverBadge" class="driver-badge">—</div>
      <button id="adminPanelBtn" style="display:none">Admin Panel</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="lobby" id="tabLobby">Lobby (Assigned)</div>
      <div class="tab" data-tab="history" id="tabHistory">History (Completed)</div>
      <button id="sortBtn" class="muted" style="max-width:220px">Sort: Recent</button>
      <div style="flex:1"></div>
      <button id="syncBtn" class="muted" style="max-width:200px">Sync Pending</button>
      <button id="changeDriverBtn" class="danger" style="max-width:200px">Change Driver</button>
    </div>
    <div id="lobby" class="tabpanel active">
      <div id="lobbyList" class="row"></div>
      <p id="lobbyEmpty" style="display:none">No pending trainings. Great job!</p>
    </div>
    <div id="history" class="tabpanel" style="display:none">
      <div id="historyList" class="row"></div>
      <p id="historyEmpty" style="display:none">No completed trainings yet.</p>
    </div>
  </div>

  <!-- Video section -->
  <div id="videoSection" class="section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <button type="button" id="closeBtn" class="danger" style="max-width:200px">Cancel</button>
      <div id="activeVideoTitle" style="font-weight:700"></div>
    </div>
    <div id="videoNote">Loading video, please wait...</div>
    <div id="videoContainer"></div>
  </div>

  <!-- Completion -->
  <div id="completionSection">
    <button id="completeBtn">Mark Complete</button>
  </div>

  <!-- Admin Login -->
  <div id="adminLoginSection" class="section" style="text-align:center">
    <div class="heading-wrap"><h2>Admin Login</h2></div>
    <div class="admin-section" style="max-width:520px">
      <input type="email" id="adminEmail" placeholder="Enter your @alistairgroup.com email" style="margin-bottom:12px" />
      <div class="row">
        <button type="button" id="adminBackBtn" class="danger" style="flex:1">Back</button>
        <button type="button" id="adminSubmitBtn" style="flex:2">Login</button>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanelSection" class="section">
    <div class="heading-wrap"><h2>Training Admin Panel</h2></div>
    <div class="admin-section">
      <div class="admin-form">
        <div class="admin-form-row">
          <select id="adminLangSelect" required>
            <option value="">Select Language</option>
          </select>
          <input type="text" id="newLangName" placeholder="New Language Name" />
          <button type="button" id="addLangBtn" class="muted">Add Language</button>
        </div>
        <input type="text" id="videoTitle" placeholder="Video Title" required />
        <div class="admin-form-row">
          <select id="videoType" required>
            <option value="">Select Video Type</option>
            <option value="youtube">YouTube</option>
            <option value="mp4">MP4 URL</option>
          </select>
          <input type="text" id="videoId" placeholder="YouTube ID or MP4 URL" required />
        </div>
        <textarea id="videoNoteAdmin" placeholder="Optional note for drivers" rows="2"></textarea>
        <button type="button" id="saveVideoBtn">Save Video</button>
      </div>
      <div class="video-list" id="adminVideoList">
        <h3>Saved Videos</h3>
        <div id="adminVideoItems"></div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button type="button" id="adminLogoutBtn" class="danger">Logout</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // ======= BACKEND BASE URL (your deployment) =======
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbyKO9F0m-VP89q2RTMpLgkKWMuUoKOR8HqReocgIrdqe7ZM1tyisLqhNDSnujdXHGyfYA/exec';

    // === CONFIG ===
    const MIN_WATCH_SECONDS = 40;
    const REVEAL_BEFORE_END = 10;
    const ALLOW_SEEK_TOLERANCE = 1.25;
    const ADMIN_EMAIL_SUFFIX = '@alistairgroup.com';

    // Storage keys
    const LS_KEY_PENDING_COMPLETIONS = 'driver_training_pending_completions_v1';
    const LS_KEY_LANG = 'driver_training_lang_v1';
    const LS_KEY_LOBBY_SORT = 'driver_training_lobby_sort_v1';
    const LS_KEY_CUSTOM_LANGS = 'driver_training_custom_langs_v1';
    const LS_DRIVER_STATE_PREFIX = 'driver_training_driverstate_';
    const LS_ADMIN_AUTH = 'driver_training_admin_auth_v1';

    // i18n
    const baseTranslations = {
      English: { code:'en', dir:'ltr', langTitle:'Select Language', pageTitle:'Driver Check-In', continue:'Continue', back:'⬅️ Back', cancel:'❌ Cancel Video', formTitle:'Driver Check-In', name:'Full Name', truck:'Truck Number', submit:'Continue to Dashboard', complete:'Course Completed Successfully!', dash:'Training Dashboard', lobby:'Lobby (Assigned)', history:'History (Completed)', sync:'Sync Pending', change:'Change Driver', play:'Play', status:'Status', assigned:'Assigned', duration:'Duration', noPending:'No pending trainings. Great job!', noHistory:'No completed trainings yet.', loadingVideo:'Loading video, please wait...', dashboardLogin:'Dashboard Login', sort:'Sort', recent:'Recent', oldest:'Oldest' },
      Swahili: { code:'sw', dir:'ltr', langTitle:'Chagua Lugha', pageTitle:'Kuingia kwa Dereva', continue:'Endelea', back:'⬅️ Rudi', cancel:'❌ Sitisha Video', formTitle:'Kuingia kwa Dereva', name:'Jina Kamili', truck:'Namba ya Gari', submit:'Nenda kwenye Dashibodi', complete:'Nimekamilisha Kozi', dash:'Dashibodi ya Mafunzo', lobby:'Ukumbi (Zilizokabidhiwa)', history:'Historia (Zilizokamilika)', sync:'Sawazisha', change:'Badilisha Dereva', play:'Cheza', status:'Hali', assigned:'Iliyokabidhiwa', duration:'Muda', noPending:'Hakuna mafunzo yanayosubiri. Kazi nzuri!', noHistory:'Bado hakuna mafunzo yaliyokamilika.', loadingVideo:'Inapakia video, tafadhali subiri...', dashboardLogin:'Kuingia Dashibodi', sort:'Panga', recent:'Za Hivi Karibuni', oldest:'Za Zamani' },
      Bemba: { code:'bem', dir:'ltr', langTitle:'Sankeni Ululimi', pageTitle:'Ifyebo fya Kwingilila', continue:'Tendekela', back:'⬅️ Baya', cancel:'❌ Fumya Video', formTitle:'Ifyebo fya Kwingilila', name:'Amashina Yonse', truck:'Namba ya Motoka', submit:'Ya ku Dashboard', complete:'Nasheya ukucita bwino!', dash:'Dashboard ya Ifyakusambilila', lobby:'Lobby (Ifyasalwike)', history:'Historia (Fyapwa)', sync:'Sync', change:'Chinja Umupashi', play:'Tamba', status:'Inshita', assigned:'Lyasangwa', duration:'Ubushiku', noPending:'Tapali ifyasangwa. Umucinshi!', noHistory:'Tachapwa nangu kamo pano.', loadingVideo:'Ukupakila video, pelako umutende...', dashboardLogin:'Ukwingila pa Dashboard', sort:'Teekanya', recent:'Ifyapya', oldest:'Ifyakale' },
      Portuguese: { code:'pt', dir:'ltr', langTitle:'Selecione o Idioma', pageTitle:'Registro do Motorista', continue:'Continuar', back:'⬅️ Voltar', cancel:'❌ Cancelar Vídeo', formTitle:'Registro do Motorista', name:'Nome Completo', truck:'Número do Caminhão', submit:'Ir para o Painel', complete:'✅ Curso concluído com sucesso!', dash:'Painel de Treinamentos', lobby:'Lobby (Atribuídos)', history:'Histórico (Concluídos)', sync:'Sincronizar', change:'Trocar Motorista', play:'Reproduzir', status:'Estado', assigned:'Atribuído', duration:'Duração', noPending:'Sem treinamentos pendentes. Bom trabalho!', noHistory:'Ainda não há treinamentos concluídos.', loadingVideo:'Carregando o vídeo, aguarde...', dashboardLogin:'Acesso ao Painel', sort:'Ordenar', recent:'Mais recentes', oldest:'Mais antigas' }
    };

    // Local catalog for offline fallback
    const baseVideoLinks = {
      English:   [ { id:'eng-001', type:'youtube', videoId:'fVl88Q5DJ2w', title:'Driver Tiredness, Fatigue and Road Safety' } ],
      Swahili:   [ { id:'swa-002', type:'mp4', url:'https://raw.githubusercontent.com/Kwibu/API-3-Test/main/Safety%20Campaign%20for%20drivers%20(Swahili).mp4', title:'Kampeni ya Usalama kwa Madereva' } ],
      Bemba:     [ { id:'bem-003', type:'mp4', url:'https://raw.githubusercontent.com/Kwibu/API-3-Test/main/Safety%20Campaign%20for%20drivers%20(Bemba).mp4', title:'Kampeni ya Ukusalama kwa Abapashi' } ],
      Portuguese:[ { id:'por-004', type:'mp4', url:'https://raw.githubusercontent.com/Kwibu/API-3-Test/main/Safety%20Campaign%20for%20drivers%20(Portugal).mp4', title:'Campanha de Segurança para Motoristas' } ]
    };

    // Helpers: custom langs in localStorage
    function loadCustomLangs(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_CUSTOM_LANGS)||'{}'); }catch{ return {}; } }
    function saveCustomLangs(obj){ localStorage.setItem(LS_KEY_CUSTOM_LANGS, JSON.stringify(obj||{})); }
    function getTranslations(){
      const custom = loadCustomLangs();
      const out = { ...baseTranslations };
      Object.entries(custom).forEach(([lang, payload])=>{
        if (payload.translations){ out[lang] = { ...baseTranslations.English, ...payload.translations }; }
      });
      return out;
    }
    function getVideoLinks(){
      const custom = loadCustomLangs();
      const out = JSON.parse(JSON.stringify(baseVideoLinks));
      Object.entries(custom).forEach(([lang, payload])=>{
        if (payload.videos && Array.isArray(payload.videos)){
          out[lang] = (out[lang]||[]).concat(payload.videos);
        }
      });
      return out;
    }
    window.addLanguage = function(langName, i18nFields, videosArray){
      const custom = loadCustomLangs();
      custom[langName] = custom[langName] || {};
      if (i18nFields) custom[langName].translations = { ...(custom[langName].translations||{}), ...i18nFields };
      if (Array.isArray(videosArray)) custom[langName].videos = (custom[langName].videos||[]).concat(videosArray);
      saveCustomLangs(custom);
      if (typeof window.populateLanguageSelect === 'function') window.populateLanguageSelect();
      if (typeof window.populateAdminLangSelect === 'function') window.populateAdminLangSelect();
      alert(`Language "${langName}" saved. Reload or re-open to use.`);
    }

    // Admin auth
    function isAdminLoggedIn(){ return localStorage.getItem(LS_ADMIN_AUTH) === 'true'; }
    function setAdminLoggedIn(status){ localStorage.setItem(LS_ADMIN_AUTH, status ? 'true' : ''); }

    // Per-driver state
    function driverKey(){ return `${driver.name}|${driver.truck}`.toLowerCase().trim(); }
    function driverStateKey(){ return LS_DRIVER_STATE_PREFIX + encodeURIComponent(driverKey()); }
    function loadDriverState(){ try{ return JSON.parse(localStorage.getItem(driverStateKey())||'{}'); }catch{ return {}; } }
    function saveDriverState(state){ localStorage.setItem(driverStateKey(), JSON.stringify(state||{})); }
    function markWatched(assignmentId, extra={}){ const st=loadDriverState(); st.watched=st.watched||{}; st.watched[assignmentId]={done:true,...extra}; saveDriverState(st); }

    // App state
    let selectedLang = localStorage.getItem(LS_KEY_LANG) || 'English';
    let lobbySort = localStorage.getItem(LS_KEY_LOBBY_SORT) || 'recent';
    let startTime, rowId, ytPlayer, progressPoll;
    let maxAllowedTime = 0, watchedSeconds = 0, minReached = false;
    let currentAssignment = null;

    const driverList = [];
    let driver = { name:'', truck:'' };

    // Utils
    function toast(msg, ms = 3000){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{ t.style.display='none'; }, ms); }
    function $(id){ return document.getElementById(id); }
    function pendingCompletions(){ try { return JSON.parse(localStorage.getItem(LS_KEY_PENDING_COMPLETIONS) || '[]'); } catch { return []; } }
    function savePendingCompletions(list){ localStorage.setItem(LS_KEY_PENDING_COMPLETIONS, JSON.stringify(list)); }
    function enqueuePending(payload){ const list=pendingCompletions(); list.push(payload); savePendingCompletions(list); }
    function generateId(){ return 'vid-' + Date.now().toString(36) + Math.random().toString(36).substring(2,6); }

    // ===== Data I/O (all to the same Apps Script) =====
    async function loadDrivers() {
      try {
        const res = await fetch(`${BASE_URL}?mode=drivers`, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const dl = $('driverNames');
        dl.innerHTML = '';
        driverList.length = 0;
        data.forEach(d => { driverList.push(d); const opt = document.createElement('option'); opt.value = d.name; dl.appendChild(opt); });
      } catch (e) {
        console.error('Driver fetch failed:', e);
        toast('Could not load driver list. You can still type your name.');
      }
    }

    async function fetchAssignments(name, truck){
      try {
        const r = await fetch(`${BASE_URL}?mode=assignments`, { cache: 'no-store' });
        if (r.ok){
          const json = await r.json();
          if (Array.isArray(json.assignments)) return json.assignments;
        }
      } catch(e){ }
      } catch(e){ /* offline fallback */ }
      // Fallback: build from local catalog (all languages)
      const vmap = getVideoLinks();
      const all = [];
      Object.entries(vmap).forEach(([lang, list])=>{
        list.forEach(v=>{
          all.push({ id:v.id, title:v.title, language:lang, source:v, status:'assigned', assignedAt:new Date().toISOString().slice(0,10) });
          all.push({ 
            id: v.id, 
            title: v.title, 
            language: lang, 
            source: v, 
            status: 'assigned', 
            assignedAt: new Date().toISOString().slice(0,10),
            isAdminAdded: true // Mark admin-added videos
          });
        });
      });
      return all;
    }

    async function fetchHistory(name, truck){
      try{
        const url = `${BASE_URL}?mode=history&name=${encodeURIComponent(name)}&truck=${encodeURIComponent(truck)}`;
        const r = await fetch(url, { cache:'no-store' });
        if (!r.ok) throw new Error('net');
        const json = await r.json();
        return Array.isArray(json.history) ? json.history : [];
      }catch(e){ return []; }
      }catch(e){
        return [];
      }
    }

    async function postTrainingEvent(payload){
      try {
        const fd = new FormData(); Object.entries(payload).forEach(([k,v])=>fd.append(k, v));
        const resp = await fetch(BASE_URL, { method: 'POST', body: fd });
        const json = await resp.json();
        if (!json.success) throw new Error(json.message || 'Server error');
        return json;
      } catch(e){ enqueuePending(payload); throw e; }
      } catch(e){
        enqueuePending(payload);
        throw e;
      }
    }

    async function postAdminVideo(videoData){
      try {
        const fd = new FormData(); 
        fd.append('mode', 'admin_add_video');
        Object.entries(videoData).forEach(([k,v])=>fd.append(k, v));
        const resp = await fetch(BASE_URL, { method: 'POST', body: fd });
        const json = await resp.json();
        if (!json.success) throw new Error(json.message || 'Server error');
        return json;
      } catch(e){
        console.log('Admin video saved locally (offline)', e);
        return { success: true, offline: true };
      }
    }

    async function flushPending(){
      const list = pendingCompletions(); if (!list.length) { toast('Nothing to sync.'); return; }
      const remaining = [];
      for (const p of list){ try { await postTrainingEvent(p); } catch(e){ remaining.push(p); } }
      for (const p of list){
        try { await postTrainingEvent(p); } catch(e){ remaining.push(p); }
      }
      savePendingCompletions(remaining);
      toast(remaining.length ? `Some items could not sync (${remaining.length}).` : 'All pending items synced.');
    }

    // ===== UI wiring =====
    document.addEventListener('DOMContentLoaded', function(){
      loadDrivers();

      // Main sections
      const langSection=$('languageSection'), checkinForm=$('checkinForm'), dashboard=$('dashboardSection');
      const videoSection=$('videoSection'), adminLoginSection=$('adminLoginSection'), adminPanelSection=$('adminPanelSection');

      // Language screen elements
      const languageSelect=$('languageSelect'), continueBtn=$('continueBtn'), backBtn=$('backBtn');
      const nameInput=$('name'), truckInput=$('truck'), submitBtn=$('submitBtn'), dashTitle=$('dashTitle'), driverBadge=$('driverBadge');
      const tabs=document.querySelectorAll('.tab'); const lobbyList=$('lobbyList'); const historyList=$('historyList');
      const lobbyEmpty=$('lobbyEmpty'); const historyEmpty=$('historyEmpty');
      const changeDriverBtn=$('changeDriverBtn'); const sortBtn=$('sortBtn'); const syncBtn=$('syncBtn');
      const changeDriverBtn=$('changeDriverBtn'); const sortBtn=$('sortBtn');

      const videoSection=$('videoSection'); const videoNote=$('videoNote'); const videoContainer=$('videoContainer');
      // Video screen elements
      const videoNote=$('videoNote'); const videoContainer=$('videoContainer');
      const closeBtn=$('closeBtn'); const activeVideoTitle=$('activeVideoTitle');

      // Admin elements
      const adminLoginBtn=$('adminLoginBtn'), adminBackBtn=$('adminBackBtn'), adminSubmitBtn=$('adminSubmitBtn');
      const adminEmail=$('adminEmail'), adminPanelBtn=$('adminPanelBtn'), adminLogoutBtn=$('adminLogoutBtn');
      const adminLangSelect=$('adminLangSelect'), newLangName=$('newLangName'), addLangBtn=$('addLangBtn');
      const videoTitle=$('videoTitle'), videoType=$('videoType'), videoId=$('videoId'), videoNoteAdmin=$('videoNoteAdmin');
      const saveVideoBtn=$('saveVideoBtn'), adminVideoItems=$('adminVideoItems');

      function populateLanguageSelect(){
        const tmap = getTranslations();
        const opts = Object.keys(tmap);
        languageSelect.innerHTML = '<option value="">-- Choose a Language --</option>' + opts.map(o=>`<option value="${o}">${o}</option>`).join('');
        languageSelect.value = selectedLang;
      }
      window.populateLanguageSelect = populateLanguageSelect;

      function populateAdminLangSelect(){
        const tmap = getTranslations();
        const opts = Object.keys(tmap);
        adminLangSelect.innerHTML = '<option value="">-- Select Language --</option>' + opts.map(o=>`<option value="${o}">${o}</option>`).join('');
      }
      window.populateAdminLangSelect = populateAdminLangSelect;

      function tFor(lang){ const map = getTranslations(); return map[lang] || map.English; }
      function applyTranslations(lang){
        const t = tFor(lang);
        document.documentElement.lang = t.code || 'en';
        document.documentElement.dir  = t.dir || 'ltr';
        $('langTitle').innerText = t.langTitle || 'Select Language';
        document.title           = t.pageTitle;
        $('continueBtn').innerText = t.continue;
        $('formTitle').innerText = t.formTitle;
        nameInput.placeholder    = t.name;
        truckInput.placeholder   = t.truck;
        submitBtn.innerText      = t.submit;
        backBtn.innerText        = t.back;
        dashTitle.textContent    = t.dash;
        $('tabLobby').textContent   = t.lobby;
        $('tabHistory').textContent = t.history;
        $('syncBtn').textContent    = t.sync;
        $('changeDriverBtn').textContent = t.change;
        lobbyEmpty.textContent      = t.noPending;
        historyEmpty.textContent    = t.noHistory;
        if (sortBtn) sortBtn.textContent = `${t.sort}: ${lobbySort==='recent'?t.recent:t.oldest}`;
        $('closeBtn').innerText  = t.cancel;
        $('videoNote').innerText = t.loadingVideo;
        $('completeBtn').innerText = t.complete;
      }

      // Admin UI functions
      function showAdminPanel(show){
        if (show && !isAdminLoggedIn()) return;
        adminPanelBtn.style.display = show ? 'block' : 'none';
      }

      function renderAdminVideoList(){
        const vmap = getVideoLinks();
        adminVideoItems.innerHTML = '';
        
        Object.entries(vmap).forEach(([lang, videos]) => {
          if (!videos.length) return;
          
          const langHeader = document.createElement('h4');
          langHeader.textContent = lang;
          langHeader.style.margin = '16px 0 8px';
          adminVideoItems.appendChild(langHeader);
          
          videos.forEach(video => {
            const item = document.createElement('div');
            item.className = 'video-item';
            item.innerHTML = `
              <div>
                <strong>${video.title}</strong>
                <div style="font-size:12px;color:#666">${video.type} • ${video.id}</div>
                ${video.note ? `<div style="font-size:12px;color:#666">${video.note}</div>` : ''}
              </div>
              <div class="video-item-actions">
                <button class="muted" onclick="window.adminPlayVideo('${lang}', '${video.id}')">Play</button>
                <button class="danger" onclick="window.adminDeleteVideo('${lang}', '${video.id}')">Delete</button>
              </div>
            `;
            adminVideoItems.appendChild(item);
          });
        });
      }
      window.adminPlayVideo = function(lang, videoId){
        const vmap = getVideoLinks();
        const video = vmap[lang]?.find(v => v.id === videoId);
        if (!video) return;
        
        // Simulate an assignment
        const fakeAssignment = {
          id: video.id,
          title: video.title,
          language: lang,
          source: video,
          status: 'assigned',
          assignedAt: new Date().toISOString().slice(0,10),
          isAdminAdded: true
        };
        
        startAssignment(fakeAssignment);
      };
      window.adminDeleteVideo = function(lang, videoId){
        if (!confirm(`Delete this video? This can't be undone.`)) return;
        
        const custom = loadCustomLangs();
        if (custom[lang]?.videos) {
          custom[lang].videos = custom[lang].videos.filter(v => v.id !== videoId);
          saveCustomLangs(custom);
          renderAdminVideoList();
          toast('Video deleted');
          
          // Refresh dashboard if open
          if (window.__assignments) {
            window.__assignments = window.__assignments.filter(a => a.id !== videoId);
            renderDashboard(window.__assignments);
          }
        }
      };

      // Initialize UI
      populateLanguageSelect();
      populateAdminLangSelect();
      languageSelect.value = selectedLang;
      applyTranslations(selectedLang);
      showAdminPanel(isAdminLoggedIn());
      renderAdminVideoList();

      // Event listeners
      languageSelect.addEventListener('change', ()=>{
        selectedLang = languageSelect.value || 'English';
        localStorage.setItem(LS_KEY_LANG, selectedLang);
        applyTranslations(selectedLang);
        if (window.__assignments) renderDashboard(window.__assignments);
      });

      continueBtn.addEventListener('click', ()=>{
        if (!languageSelect.value){ alert('Please select a language.'); return; }
        selectedLang = languageSelect.value; localStorage.setItem(LS_KEY_LANG, selectedLang);
        applyTranslations(selectedLang);
        langSection.classList.remove('active'); checkinForm.classList.add('active');
      });

      backBtn.addEventListener('click', ()=>{
        checkinForm.reset(); languageSelect.value = selectedLang;
        applyTranslations(selectedLang);
        checkinForm.classList.remove('active'); langSection.classList.add('active');
      });

      // Admin login/logout
      adminLoginBtn.addEventListener('click', () => {
        langSection.classList.remove('active');
        adminLoginSection.classList.add('active');
      });

      adminBackBtn.addEventListener('click', () => {
        adminLoginSection.classList.remove('active');
        langSection.classList.add('active');
      });

      adminSubmitBtn.addEventListener('click', () => {
        const email = adminEmail.value.trim();
        if (!email.endsWith(ADMIN_EMAIL_SUFFIX)) {
          alert(`Only @alistairgroup.com emails are allowed.`);
          return;
        }
        setAdminLoggedIn(true);
        adminLoginSection.classList.remove('active');
        adminPanelSection.classList.add('active');
        adminEmail.value = '';
        showAdminPanel(true);
      });

      adminPanelBtn.addEventListener('click', () => {
        dashboard.classList.remove('active');
        adminPanelSection.classList.add('active');
      });

      adminLogoutBtn.addEventListener('click', () => {
        setAdminLoggedIn(false);
        adminPanelSection.classList.remove('active');
        langSection.classList.add('active');
        showAdminPanel(false);
      });

      // Admin video management
      addLangBtn.addEventListener('click', () => {
        const langName = newLangName.value.trim();
        if (!langName) {
          alert('Please enter a language name');
          return;
        }
        
        const custom = loadCustomLangs();
        if (!custom[langName]) {
          custom[langName] = { translations: {}, videos: [] };
          saveCustomLangs(custom);
          populateLanguageSelect();
          populateAdminLangSelect();
          newLangName.value = '';
          toast(`Language "${langName}" added`);
        } else {
          alert('This language already exists');
        }
      });

      saveVideoBtn.addEventListener('click', async () => {
        const lang = adminLangSelect.value;
        const title = videoTitle.value.trim();
        const type = videoType.value;
        const idOrUrl = videoId.value.trim();
        const note = videoNoteAdmin.value.trim();
        
        if (!lang || !title || !type || !idOrUrl) {
          alert('Please fill all required fields');
          return;
        }
        
        const videoData = {
          id: generateId(),
          title,
          type,
          note,
          [type === 'youtube' ? 'videoId' : 'url']: idOrUrl
        };
        
        // Save locally
        const custom = loadCustomLangs();
        custom[lang] = custom[lang] || { translations: {}, videos: [] };
        custom[lang].videos = custom[lang].videos.filter(v => v.id !== videoData.id); // Remove if exists
        custom[lang].videos.push(videoData);
        saveCustomLangs(custom);
        
        // Try to sync to server
        try {
          await postAdminVideo({
            language: lang,
            ...videoData
          });
          toast('Video saved' + (window.navigator.onLine ? '' : ' (offline)'));
        } catch(e) {
          toast('Video saved locally (offline)');
        }
        
        // Reset form and refresh lists
        videoTitle.value = '';
        videoType.value = '';
        videoId.value = '';
        videoNoteAdmin.value = '';
        renderAdminVideoList();
      });

      // Datalist auto-fill for truck when exact match on name
      nameInput.addEventListener('input', ()=>{
        const match = driverList.find(d => d.name.toLowerCase() === nameInput.value.toLowerCase());
        truckInput.value = match ? match.truck : '';
      });

      checkinForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!nameInput.value.trim() || !truckInput.value.trim()){ alert('Please fill in all fields.'); return; }
        submitBtn.disabled = true;
        driver = { name: nameInput.value.trim(), truck: truckInput.value.trim() };

        const st0 = loadDriverState(); st0.lang = selectedLang; saveDriverState(st0);

        driverBadge.textContent = `${driver.name} • ${driver.truck}`;
        applyTranslations(selectedLang);

        let assignments = await fetchAssignments(driver.name, driver.truck);
        const history = await fetchHistory(driver.name, driver.truck);
        assignments = mergeServerHistory(assignments, history);
        hydrateLocalWatchedFromServer(history);

        window.__assignments = assignments;
        renderDashboard(assignments);

        checkinForm.classList.remove('active'); dashboard.classList.add('active');
        submitBtn.disabled = false;
      }); // closed correctly so functions below are top-scope

        try {
          await postTrainingEvent({ name: driver.name, truck: driver.truck, language: selectedLang, videoTitle: tFor(selectedLang).dashboardLogin, status: 'Session Start' });
        } catch(e){ /* queued */ }
      });

      function setActiveTab(tabName){
        document.querySelectorAll('.tab').forEach(el=>el.classList.toggle('active', el.dataset.tab===tabName));
        document.querySelectorAll('.tabpanel').forEach(el=>el.style.display = (el.id===tabName? 'block':'none'));
      }
      tabs.forEach(t=> t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));

      changeDriverBtn.addEventListener('click', ()=>{
      $('changeDriverBtn').addEventListener('click', ()=>{
        dashboard.classList.remove('active'); checkinForm.classList.add('active'); applyTranslations(selectedLang);
      });
      syncBtn.addEventListener('click', flushPending);
      $('syncBtn').addEventListener('click', flushPending);
      if (sortBtn) sortBtn.addEventListener('click', ()=>{
        lobbySort = (lobbySort==='recent') ? 'oldest' : 'recent';
        localStorage.setItem(LS_KEY_LOBBY_SORT, lobbySort);
        applyTranslations(selectedLang);
        renderDashboard(window.__assignments || []);
      });

      function mergeServerHistory(assignments, hist){
        const byId = new Map(assignments.map(a=>[a.id,a]));
        hist.forEach(h=>{
          const a = byId.get(h.assignmentId);
          if (a){
            a.status = 'completed';
            a.completedAt = h.completedAt || a.completedAt || new Date().toISOString().slice(0,10);
            a.duration = h.duration || a.duration;
            a.language = h.language || a.language;
          } else {
            byId.set(h.assignmentId, { id: h.assignmentId, title: h.title || 'Completed Training', language: h.language || selectedLang, source: null, status: 'completed', completedAt: h.completedAt || new Date().toISOString().slice(0,10), duration: h.duration });
            byId.set(h.assignmentId, {
              id: h.assignmentId,
              title: h.title || 'Completed Training',
              language: h.language || selectedLang,
              source: null,
              status: 'completed',
              completedAt: h.completedAt || new Date().toISOString().slice(0,10),
              duration: h.duration
            });
          }
        });
        return Array.from(byId.values());
      }

      function hydrateLocalWatchedFromServer(hist){
        if (!hist || !hist.length) return;
        const st = loadDriverState(); st.watched = st.watched || {};
        hist.forEach(h=>{ st.watched[h.assignmentId] = { done:true, completedAt: h.completedAt || new Date().toISOString().slice(0,10), duration: h.duration, language: h.language }; });
        hist.forEach(h=>{
          st.watched[h.assignmentId] = { done:true, completedAt: h.completedAt || new Date().toISOString().slice(0,10), duration: h.duration, language: h.language };
        });
        saveDriverState(st);
      }

      function renderDashboard(assignments){
        window.__assignments = assignments;
        const t = tFor(selectedLang);
        const st = loadDriverState();
        const watched = st.watched || {};

        const inLang = assignments.filter(a=> (a.language||selectedLang) === selectedLang);

        inLang.forEach(a=>{
          if (watched[a.id]?.done) {
            a.status = 'completed';
            a.completedAt = a.completedAt || watched[a.id].completedAt;
            a.duration = a.duration || watched[a.id].duration;
          }
        });

        const pending = inLang.filter(a=>a.status !== 'completed');
        pending.sort((a,b)=>{
          const da = Date.parse(a.assignedAt||'');
          const db = Date.parse(b.assignedAt||'');
          const va = isNaN(da) ? (lobbySort==='recent' ? -Infinity : Infinity) : da;
          const vb = isNaN(db) ? (lobbySort==='recent' ? -Infinity : Infinity) : db;
          return lobbySort==='recent' ? (vb - va) : (va - vb);
        });
        lobbyList.innerHTML = '';
        lobbyEmpty.style.display = pending.length ? 'none' : 'block';
        pending.forEach(a=> lobbyList.appendChild(makeAssignmentCard(a, true, t)));

        const done = inLang.filter(a=>a.status === 'completed');
        done.sort((a,b)=> Date.parse(b.completedAt||0) - Date.parse(a.completedAt||0));
        historyList.innerHTML = '';
        historyEmpty.style.display = done.length ? 'none' : 'block';
        done.forEach(a=> historyList.appendChild(makeAssignmentCard(a, false, t)));
      }

      function makeAssignmentCard(a, withPlay, t){
        const card = document.createElement('div'); card.className = 'card';
        const when  = a.status==='completed' ? (a.completedAt? ` • ${a.completedAt}`: '') : (a.assignedAt? ` • ${t.assigned} ${a.assignedAt}`: '');
        const when  = a.status==='completed'
          ? (a.completedAt? ` • ${a.completedAt}`: '')
          : (a.assignedAt? ` • ${t.assigned} ${a.assignedAt}`: '');
        card.innerHTML = `<div style="font-weight:700">${a.title}<span class="pill">${a.language}</span></div><div style="font-size:13px;color:#374151;margin:6px 0 10px">${t.status}: ${a.status}${when}</div>`;
        if (withPlay){
          const btn = document.createElement('button'); btn.textContent = t.play; btn.addEventListener('click', ()=> startAssignment(a)); card.appendChild(btn);
        } else if (a.duration) {
          const note = document.createElement('div'); note.style.fontSize='12px'; note.style.color='#6b7280'; note.textContent = `${t.duration}: ${a.duration}`; card.appendChild(note);
        }
        return card;
      }

      async function startAssignment(a){
        currentAssignment = a; maxAllowedTime = 0; watchedSeconds = 0; minReached = false;
        selectedLang = a.language || selectedLang || 'English';
        localStorage.setItem(LS_KEY_LANG, selectedLang);
        applyTranslations(selectedLang);

        startTime = new Date();
        const payload = { name: driver.name, truck: driver.truck, language: selectedLang, videoTitle: a.title, status: 'Course Started', assignmentId: a.id };
        try { const res = await postTrainingEvent(payload); rowId = res.row; } catch(e){ }
        try { const res = await postTrainingEvent(payload); rowId = res.row; } catch(e){ /* queued */ }

        $('dashboardSection').classList.remove('active');
        $('videoSection').classList.add('active');

        activeVideoTitle.textContent = a.title;
        const catalog = tFor(selectedLang);
        const vmap = getVideoLinks();
        const langList = vmap[selectedLang]||[];
        const meta = langList.find(v=>v.id===a.id) || {};
        $('videoNote').innerText = (meta.note) || (catalog ? catalog.loadingVideo : 'Loading video...');
        $('completionSection').style.display = 'none';
        $('completeBtn').disabled = false;
        videoContainer.innerHTML = '';

        if (a.source?.type === 'youtube' || meta.type==='youtube') {
          const videoId = a.source?.videoId || meta.videoId;
          videoContainer.innerHTML = '<div id="ytPlayer"></div>';
          window.onYouTubeIframeAPIReady = function () {
            ytPlayer = new YT.Player('ytPlayer', {
              videoId,
              width: '100%', height: '390',
              playerVars: { controls: 1, disablekb: 1, fs: 0, modestbranding: 1, rel: 0, iv_load_policy: 3, playsinline: 1 },
              events: { onReady: onYTReady, onStateChange: onYTState }
            });
          };
          if (window.YT && window.YT.Player) window.onYouTubeIframeAPIReady();
        } else if (a.source?.type === 'mp4' || meta.type==='mp4') {
          const url = a.source?.url || meta.url;
          videoContainer.innerHTML = `<video id="trainingVideo" controls controlsList="nodownload noplaybackrate noremoteplayback" disablepictureinpicture playsinline src="${url}"></video>`;
          const tv = $('trainingVideo');
          tv.playbackRate = 1; tv.addEventListener('ratechange', ()=>{ if (tv.playbackRate !== 1) tv.playbackRate = 1; });
          tv.addEventListener('seeking', ()=>{ if (tv.currentTime > maxAllowedTime + ALLOW_SEEK_TOLERANCE) tv.currentTime = maxAllowedTime; });
          tv.addEventListener('timeupdate', ()=>{
            if (tv.currentTime > maxAllowedTime) maxAllowedTime = tv.currentTime;
            watchedSeconds = Math.max(watchedSeconds, Math.floor(maxAllowedTime));
            if (!minReached && watchedSeconds >= MIN_WATCH_SECONDS) { minReached = true; $('completionSection').style.display = 'block'; }
            const remaining = tv.duration - tv.currentTime; if (remaining <= REVEAL_BEFORE_END) $('completionSection').style.display = 'block';
          });
          tv.addEventListener('ended', autoComplete);
          tv.play().catch(()=>toast('Tap play to start the video.'));
        } else {
          toast('Video source missing.');
        }
      }

      function onYTReady(event){
        try { event.target.setPlaybackRate(1); } catch(_){}
        event.target.playVideo();
        clearInterval(progressPoll);
        progressPoll = setInterval(()=>{
          if (!ytPlayer) return;
          const ct = ytPlayer.getCurrentTime(); const dur = ytPlayer.getDuration();
          if (ct > maxAllowedTime) maxAllowedTime = ct;
          if (ct > maxAllowedTime + ALLOW_SEEK_TOLERANCE) { ytPlayer.seekTo(maxAllowedTime, true); }
          watchedSeconds = Math.max(watchedSeconds, Math.floor(maxAllowedTime));
          if (!minReached && watchedSeconds >= MIN_WATCH_SECONDS) { minReached = true; $('completionSection').style.display = 'block'; }
          if (dur && (dur - ct) <= REVEAL_BEFORE_END) $('completionSection').style.display = 'block';
          try { if (ytPlayer.getPlaybackRate && ytPlayer.getPlaybackRate() !== 1) ytPlayer.setPlaybackRate(1); } catch(_){ }
          try { if (ytPlayer.getPlaybackRate && ytPlayer.getPlaybackRate() !== 1) ytPlayer.setPlaybackRate(1); } catch(_){}
        }, 500);
      }
      function onYTState(e){ const YTENDED = 0; if (e.data === YTENDED) autoComplete(); }
      async function autoComplete(){ if (!minReached && watchedSeconds < MIN_WATCH_SECONDS) { $('completionSection').style.display = 'block'; return; } await submitCompletion(); }

      async function submitCompletion(){
        const end = new Date(); const ms = end - startTime; const durationMin = Math.max(1, Math.round(ms/60000));
        const payload = { name: driver.name, truck: driver.truck, videoTitle: currentAssignment?.title || 'Unknown', status:'Completed', duration: `${durationMin} minutes`, rowId, assignmentId: currentAssignment?.id, language: selectedLang };
        const payload = {
          name: driver.name, truck: driver.truck, videoTitle: currentAssignment?.title || 'Unknown',
          status:'Completed', duration: `${durationMin} minutes`, rowId, assignmentId: currentAssignment?.id, language: selectedLang
        };
        let ok = true;
        try { await postTrainingEvent(payload); } catch(e){ ok = false; }

        if (currentAssignment?.id) markWatched(currentAssignment.id, { completedAt: new Date().toISOString().slice(0,10), duration: `${durationMin} minutes`, language: selectedLang });
        if (currentAssignment?.id) markWatched(currentAssignment.id, {
          completedAt: new Date().toISOString().slice(0,10), duration: `${durationMin} minutes`, language: selectedLang
        });

        if (window.__assignments && currentAssignment){
          const idx = window.__assignments.findIndex(x=>x.id===currentAssignment.id);
          if (idx>-1){
            window.__assignments[idx].status='completed';
            window.__assignments[idx].completedAt = new Date().toISOString().slice(0,10);
            window.__assignments[idx].duration = `${durationMin} minutes`;
            window.__assignments[idx].language = selectedLang;
          }
        }

        $('completionSection').innerHTML = `<h3>${tFor(selectedLang).complete}</h3>`;
        videoContainer.innerHTML = '';
        setTimeout(()=>{
          $('videoSection').classList.remove('active');
          $('dashboardSection').classList.add('active');
          $('completionSection').style.display='none';
          $('completionSection').innerHTML = '<button id="completeBtn">Mark Complete</button>';
          attachCompleteButton();
          renderDashboard(window.__assignments||[]);
          applyTranslations(selectedLang);
        }, 1200);

        if (!ok) toast('Saved offline. Will sync when you tap "Sync Pending".');
      }

      function attachCompleteButton(){ const btn = $('completeBtn'); if (btn) btn.addEventListener('click', submitCompletion); }
      $('completeBtn').addEventListener('click', submitCompletion);
      closeBtn.addEventListener('click', ()=>{
        clearInterval(progressPoll);
        if (ytPlayer) { try { ytPlayer.destroy(); } catch(e){} ytPlayer = null; }
        $('videoSection').classList.remove('active');
        $('dashboardSection').classList.add('active');
        $('completionSection').style.display='none';
        videoContainer.innerHTML='';
        applyTranslations(selectedLang);
      });

      attachCompleteButton();
      applyTranslations(selectedLang);

      console.assert(typeof submitCompletion === 'function', 'submitCompletion should be defined');
      console.assert(typeof autoComplete === 'function', 'autoComplete should be defined');
    });
  </script>
</body>
</html>
